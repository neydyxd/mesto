(()=>{"use strict";const e={conteinerSelector:".poster",formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__save",inactiveButtonClass:"popup__save_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},t=class{constructor(e,t){this._config=e,this._formElement=t,this._inputList=Array.from(this._formElement.querySelectorAll(this._config.inputSelector)),this._formButton=this._formElement.querySelector(this._config.submitButtonSelector)}_showInputError(e){const t=this._formElement.querySelector(`.${e.id}-error`);e.classList.add(this._config.inputErrorClass),t.textContent=e.validationMessage,t.classList.add(this._config.errorClass)}_hideInputError(e){const t=this._formElement.querySelector(`.${e.id}-error`);e.classList.remove(this._config.inputErrorClass),t.classList.remove(this._config.errorClass),t.textContent=""}_isValid(e){e.validity.valid?this._hideInputError(e):this._showInputError(e)}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}_toggleButtonState(){this._hasInvalidInput()?this._disableSubmitButton():(this._formButton.classList.remove(this._config.inactiveButtonClass),this._formButton.removeAttribute("disabled"))}_setEventListeners(){this._toggleButtonState(),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._isValid(e),this._toggleButtonState()}))}))}_disableSubmitButton(){this._formButton.classList.add(this._config.inactiveButtonClass),this._formButton.setAttribute("disabled","disabled")}enableValidation(){this._formElement.addEventListener("submit",(()=>{this._disableSubmitButton()})),this._setEventListeners()}},s=class{constructor(e,t,s,r,o,i,n){this._name=e.name,this._link=e.link,this._templateSelector=s,this._handleCardClick=r,this._isOwner=e.owner._id===t,this._owner=e.owner._id,this._currentUserId=t,this._handleCartByClick=o,this._id=e._id,this._likes=e.likes,this._likeMyCard=i,this._deleteLikeMyCard=n}_getTemplate(){return document.querySelector(this._templateSelector).content.querySelector(".poster__item").cloneNode(!0)}_setEventListeners(){this._cardImage=this._element.querySelector(".poster__photo"),this._cardImage.addEventListener("click",(()=>{this._handleCardClick(this._name,this._link)})),this._iconDelete=this._element.querySelector(".poster__delete-button"),this._iconDelete.addEventListener("click",(()=>{this._handleCartByClick(this._id,this._element)})),this._iconLike=this._element.querySelector(".poster__like-button"),this._iconLike.addEventListener("click",(e=>{this._setLikes(e)}))}generateCard(){return this._element=this._getTemplate(),this._setEventListeners(),this._cardImage.src=this._link,this._cardTitle=this._element.querySelector(".poster__title"),this._cardTitle.textContent=this._name,this._cardImage.alt=this._name,this._iconLikeNamber=this._element.querySelector(".poster__like-number"),this._iconLikeNamber.textContent=this._likes.length,this._isOwner||this._element.querySelector(".poster__delete-button").remove(),this._addlikedCard()?this._iconLike.classList.add("poster__like-button_active"):this._iconLike.classList.remove("poster__like-button_active"),this._element}likeCard(e){this._iconLikeNamber.textContent=e.likes.length,this._iconLike.classList.toggle("poster__like-button_active")}_setLikes(e){e.target.classList.contains("poster__like-button_active")?this._deleteLikeMyCard(this._id,this):this._likeMyCard(this._id,this)}_addlikedCard(){return this._likes.find((e=>e._id===this._currentUserId))}},r=class{constructor(e){this._popup=e,this._handleEscClose=this._handleEscClose.bind(this)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose(e){"Escape"===e.code&&this.close()}setEventListeners(){this._popup.addEventListener("mousedown",(e=>{e.target.classList.contains("popup_opened")&&this.close(),e.target.classList.contains("popup__close")&&this.close()}))}},o=class extends r{constructor(e,t){super(e),this._buttonSubmit=this._popup.querySelector(".popup__save"),this._form=this._popup.querySelector(".popup__form"),this._inputs=Array.from(this._form.querySelectorAll(".popup__input")),this._handleSubmitForm=t}_getInputValues(){return this._data={},this._inputs.forEach((e=>{this._data[e.name]=e.value})),this._data}close(){this._form.reset(),super.close()}setEventListeners(){this._form.addEventListener("submit",(e=>{e.preventDefault(),this._handleSubmitForm(this._getInputValues()),this.close()})),super.setEventListeners()}renderLoadingSave(e){this._buttonSubmit.textContent=e?"Сохранение...":"Сохранить"}},i=document.querySelector(".popup-edit"),n=document.querySelector(".popup-add"),a=document.querySelector(".popup__form_edit"),_=document.querySelector(".popup__form_add"),c=(document.querySelector(".popup-photo__container"),document.querySelector(".popup__form_avatar")),l=document.querySelector(".profile__edit-button"),u=document.querySelector(".profile__name"),d=document.querySelector(".profile__about"),h=document.querySelector(".popup__close"),p=document.querySelector(".popup__close-add"),m=(document.querySelector(".popup__input_name"),document.querySelector(".popup__input_about"),document.querySelector(".popup__form_edit"),document.querySelector(".popup__form_add"),document.querySelector(".profile__add-button")),v=document.querySelector(".popup__input_name"),f=document.querySelector(".popup__input_about"),g=document.querySelector(".popup-photo__close"),S=(document.querySelector(".popup-photo__image"),document.querySelector(".popup-photo__subtitle"),document.querySelector(".popup-photo")),b=(document.querySelector(".popup__save_add"),document.querySelector(".poster"),document.querySelector(".poster__photo-button"),document.querySelector(".popup-avatar")),y=document.querySelector(".profile__avatar-button"),L=document.querySelector(".popup__close-avatar"),k=document.querySelector(".popup-delete");new t(e,a).enableValidation(),new t(e,_).enableValidation(),new t(e,c).enableValidation();const E=new class extends r{constructor(e,t){super(e),this._form=this._popup.querySelector(".popup__form"),this._deleteMyCard=t,this._buttonSubmitDelete=this._form.querySelector(".popup__save_delete")}open(e,t){super.open(),this._card=t,this._cardId=e}setEventListeners(){this._form.addEventListener("submit",(e=>{e.preventDefault(),this._deleteMyCard(this._cardId,this._card),this.close()})),super.setEventListeners()}renderLoadingDelete(e){this._buttonSubmitDelete.textContent=e?"Сохранение...":"Да"}}(k,(function(e,t){E.renderLoadingDelete(!0),C.deleteCard(e).then((()=>{t.remove(),E.close()})).catch((e=>{console.log(e)})).finally((()=>{E.renderLoadingDelete(!1)}))})),C=new class{constructor(e,t){this._basePath=e,this._token=t}_getHeaders(){return{"Content-type":"application/json",authorization:this._token}}_getJson(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}getCards(){return fetch(`${this._basePath}/cards`,{headers:this._getHeaders()}).then(this._getJson)}createNewCard(e){return fetch(`${this._basePath}/cards`,{method:"POST",headers:this._getHeaders(),body:JSON.stringify(e)}).then(this._getJson)}getCurrentUser(){return fetch(`${this._basePath}/users/me `,{headers:this._getHeaders()}).then(this._getJson)}deleteCard(e){return fetch(`${this._basePath}/cards/${e} `,{method:"DELETE",headers:this._getHeaders()}).then(this._getJson)}createNewAvatar(e){return fetch(`${this._basePath}/users/me/avatar`,{method:"PATCH",headers:this._getHeaders(),body:JSON.stringify({avatar:e.link})}).then(this._getJson)}createNewProfile(e){return fetch(`${this._basePath}/users/me`,{method:"PATCH",headers:this._getHeaders(),body:JSON.stringify({name:e.name,about:e.job})}).then(this._getJson)}putLike(e){return fetch(`${this._basePath}/cards/${e}/likes`,{method:"PUT",headers:this._getHeaders()}).then(this._getJson)}deleteLike(e){return fetch(`${this._basePath}/cards/${e}/likes`,{method:"DELETE",headers:this._getHeaders()}).then(this._getJson)}}("https://mesto.nomoreparties.co/v1/cohort-61","29be019e-c08f-4e81-b274-91fdbf94fa96");let q;function I(e){return new s(e,q,".poster-template",U,w,B,P).generateCard()}function w(e,t){E.open(e,t)}function B(e,t){C.putLike(e).then((e=>{t.likeCard(e)})).catch((e=>{console.log(e)}))}function P(e,t){C.deleteLike(e).then((e=>{t.likeCard(e)})).catch((e=>{console.log(e)}))}Promise.all([C.getCards(),C.getCurrentUser()]).then((([e,t])=>{J.setUserInfo(t),q=t._id,x.renderItems(e)}));const x=new class{constructor({renderer:e},t){this._renderer=e,this._container=document.querySelector(t)}renderItems(e){e.reverse().forEach((e=>{this._renderer(e)}))}addItem(e){this._container.prepend(e)}}({renderer:e=>{const t=I(e);x.addItem(t)}},".poster"),$=new o(n,(e=>{$.renderLoadingSave(!0),C.createNewCard(e).then((e=>{x.addItem(I(e))})).catch((e=>{console.log(e)})).finally((()=>{$.renderLoadingSave(!1)}))}));$.setEventListeners(),E.setEventListeners();const N=new o(b,(function(e){N.renderLoadingSave(!0),C.createNewAvatar(e).then((e=>{J.setUserInfo(e),N.close()})).catch((e=>{console.log(e)})).finally((()=>{N.renderLoadingSave(!1)}))}));y.addEventListener("click",(()=>{N.open()})),L.addEventListener("click",(()=>{N.close()})),N.setEventListeners();const D=new class extends r{constructor(e){super(e),this._image=this._popup.querySelector(".popup-photo__image"),this._title=this._popup.querySelector(".popup-photo__subtitle")}open(e,t){this._image.src=t,this._image.alt=e,this._title.textContent=e,super.open()}}(S);D.setEventListeners();const J=new class{constructor({name:e,about:t,avatar:s}){this._name=e,this._about=t,this._avatar=s}getUserInfo(){return{name:this._name.textContent,about:this._about.textContent,avatar:this._avatar.src}}setUserInfo({name:e,about:t,avatar:s}){this._name.textContent=e,this._about.textContent=t,this._avatar.src=s}}({name:u,about:d,avatar:document.querySelector(".profile__avatar")}),H=new o(i,(function(e){H.renderLoadingSave(!0),C.createNewProfile(e).then((e=>{J.setUserInfo(e),H.close()})).catch((e=>{console.log(e)})).finally((()=>{H.renderLoadingSave(!1)}))}));function U(e,t){D.open(e,t)}H.setEventListeners(),l.addEventListener("click",(e=>{e.preventDefault(),H.open();const t=J.getUserInfo();v.value=t.name,f.value=t.about})),m.addEventListener("click",(()=>{$.open()})),p.addEventListener("click",(()=>{$.close()})),g.addEventListener("click",(()=>{D.close()})),h.addEventListener("click",(()=>{H.close()}))})();